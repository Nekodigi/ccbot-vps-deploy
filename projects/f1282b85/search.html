<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="ã‚¤ãƒ™ãƒ³ãƒˆãƒã‚±ãƒƒãƒˆã‚’æ¤œç´¢ã™ã‚‹">
  <meta property="og:title" content="ãƒã‚±ãƒƒãƒˆã‚¢ãƒ—ãƒª - ã‚¤ãƒ™ãƒ³ãƒˆæ¤œç´¢">
  <meta property="og:description" content="ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚„æ—¥ä»˜ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œç´¢">
  <meta property="og:type" content="website">
  <meta property="og:url" content="https://vps.nekodigi.com/ccbot/projects/f1282b85/search.html">
  <meta name="twitter:card" content="summary">
  <meta name="twitter:title" content="ãƒã‚±ãƒƒãƒˆã‚¢ãƒ—ãƒª - ã‚¤ãƒ™ãƒ³ãƒˆæ¤œç´¢">
  <meta name="twitter:description" content="ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚„æ—¥ä»˜ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’æ¤œç´¢">
  <title>ã‚¤ãƒ™ãƒ³ãƒˆæ¤œç´¢ - ãƒã‚±ãƒƒãƒˆã‚¢ãƒ—ãƒª</title>
  <link rel="stylesheet" href="./css/style.css">
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#1a73e8">
</head>
<body>
  <header>
    <div class="header-content">
      <a href="./" class="logo">ãƒã‚±ãƒƒãƒˆã‚¢ãƒ—ãƒª</a>
      <nav>
        <ul>
          <li><a href="./">ãƒ›ãƒ¼ãƒ </a></li>
          <li><a href="./search.html">æ¤œç´¢</a></li>
          <li><a href="./mytickets.html">ãƒã‚¤ãƒã‚±ãƒƒãƒˆ</a></li>
          <li><a href="#" id="logout-btn">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</a></li>
        </ul>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <h1 class="page-title">ã‚¤ãƒ™ãƒ³ãƒˆæ¤œç´¢</h1>

      <div class="search-form">
        <form id="searchForm">
          <div class="search-filters">
            <div class="form-group">
              <label for="keyword">ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰</label>
              <input type="text" id="keyword" placeholder="ã‚¤ãƒ™ãƒ³ãƒˆåã§æ¤œç´¢">
            </div>
            <div class="form-group">
              <label for="category">ã‚«ãƒ†ã‚´ãƒªãƒ¼</label>
              <select id="category">
                <option value="">ã™ã¹ã¦</option>
              </select>
            </div>
            <div class="form-group">
              <label for="dateFrom">é–‹å§‹æ—¥</label>
              <input type="date" id="dateFrom">
            </div>
            <div class="form-group">
              <label for="dateTo">çµ‚äº†æ—¥</label>
              <input type="date" id="dateTo">
            </div>
          </div>
          <button type="submit" class="btn btn-primary">æ¤œç´¢</button>
        </form>
      </div>

      <div id="results-summary" style="margin-bottom: 24px; color: var(--text-secondary);"></div>

      <div id="loading" class="loading" style="display: none;">
        <div class="spinner"></div>
        <p>æ¤œç´¢ä¸­...</p>
      </div>

      <div id="results-container" class="grid"></div>

      <div id="empty-state" class="empty-state" style="display: none;">
        <div class="empty-state-icon">ğŸ”</div>
        <div class="empty-state-title">ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>
        <p>æ¤œç´¢æ¡ä»¶ã‚’å¤‰æ›´ã—ã¦ãŠè©¦ã—ãã ã•ã„</p>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 ãƒã‚±ãƒƒãƒˆã‚¢ãƒ—ãƒª. All rights reserved.</p>
    </div>
  </footer>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.13.2/firebase-firestore-compat.js"></script>

  <!-- App Scripts -->
  <script src="./js/config.js"></script>
  <script src="./js/auth.js"></script>
  <script src="./js/search.js"></script>

  <script>
    let currentUser = null;
    let allEvents = [];

    // FirebaseåˆæœŸåŒ–
    initializeFirebase().then(async () => {
      currentUser = await checkAuth(true);
      if (currentUser) {
        await initializePage();
      }
    });

    // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
    document.getElementById('logout-btn').addEventListener('click', (e) => {
      e.preventDefault();
      signOut();
    });

    // ãƒšãƒ¼ã‚¸åˆæœŸåŒ–
    async function initializePage() {
      // ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠè‚¢ã‚’è¨­å®š
      const categorySelect = document.getElementById('category');
      const categories = getCategories();
      categorySelect.innerHTML = categories.map(cat =>
        `<option value="${cat.value}">${cat.label}</option>`
      ).join('');

      // å…¨ã‚¤ãƒ™ãƒ³ãƒˆã‚’èª­ã¿è¾¼ã¿
      await loadAllEvents();
    }

    // å…¨ã‚¤ãƒ™ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿
    async function loadAllEvents() {
      showLoading();
      const result = await getAllEvents();

      if (result.success) {
        allEvents = result.events;
        displayResults(allEvents);
      } else {
        hideLoading();
        showEmptyState();
      }
    }

    // æ¤œç´¢ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('searchForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const filters = {
        keyword: document.getElementById('keyword').value.trim(),
        category: document.getElementById('category').value,
        dateFrom: document.getElementById('dateFrom').value,
        dateTo: document.getElementById('dateTo').value
      };

      showLoading();

      const result = await searchEvents(filters);

      if (result.success) {
        displayResults(result.events);
      } else {
        hideLoading();
        showEmptyState();
      }
    });

    // æ¤œç´¢çµæœã®è¡¨ç¤º
    function displayResults(events) {
      hideLoading();

      const container = document.getElementById('results-container');
      const summary = document.getElementById('results-summary');
      const emptyState = document.getElementById('empty-state');

      if (events.length === 0) {
        container.innerHTML = '';
        summary.textContent = '';
        emptyState.style.display = 'block';
        return;
      }

      emptyState.style.display = 'none';
      summary.textContent = `${events.length}ä»¶ã®ã‚¤ãƒ™ãƒ³ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸ`;

      container.innerHTML = events.map(event => createEventCard(event)).join('');
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆã‚«ãƒ¼ãƒ‰ã®ä½œæˆ
    function createEventCard(event) {
      return `
        <div class="card event-card" onclick="window.location.href='./detail.html?id=${event.id}'">
          <div class="event-image">${event.title.charAt(0)}</div>
          <span class="event-category">${getCategoryLabel(event.category)}</span>
          <h3 class="card-title">${event.title}</h3>
          <p class="event-date">${formatDate(event.date)}</p>
          <p class="card-subtitle">${event.location}</p>
          <p class="card-subtitle">${event.description}</p>
          <p class="event-price">${formatPrice(event.price)}</p>
          <p style="color: var(--text-secondary); font-size: 14px; margin-top: 8px;">
            æ®‹ã‚Š ${event.availableTickets} æš
          </p>
        </div>
      `;
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
    function showLoading() {
      document.getElementById('loading').style.display = 'block';
      document.getElementById('results-container').style.display = 'none';
      document.getElementById('empty-state').style.display = 'none';
    }

    // ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°éè¡¨ç¤º
    function hideLoading() {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('results-container').style.display = 'grid';
    }

    // ç©ºã®çŠ¶æ…‹ã‚’è¡¨ç¤º
    function showEmptyState() {
      document.getElementById('results-container').style.display = 'none';
      document.getElementById('empty-state').style.display = 'block';
    }

    // Service Workerç™»éŒ²
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(() => console.log('Service Worker registered'))
        .catch(err => console.error('Service Worker registration failed:', err));
    }
  </script>
</body>
</html>
