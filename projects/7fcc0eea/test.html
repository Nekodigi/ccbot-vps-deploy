<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR App Test Suite</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background-color: #F5F5F5;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background-color: white;
            padding: 32px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            color: #212121;
            margin-bottom: 24px;
            font-size: 32px;
        }

        h2 {
            color: #2196F3;
            margin: 24px 0 16px;
            font-size: 24px;
            border-bottom: 2px solid #2196F3;
            padding-bottom: 8px;
        }

        .test-section {
            margin-bottom: 32px;
        }

        .test-item {
            background-color: #F5F5F5;
            padding: 16px;
            margin: 12px 0;
            border-radius: 4px;
            border-left: 4px solid #757575;
        }

        .test-item.pass {
            border-left-color: #4CAF50;
            background-color: #E8F5E9;
        }

        .test-item.fail {
            border-left-color: #F44336;
            background-color: #FFEBEE;
        }

        .test-item.warning {
            border-left-color: #FF9800;
            background-color: #FFF3E0;
        }

        .test-name {
            font-weight: 600;
            margin-bottom: 8px;
            color: #212121;
        }

        .test-result {
            font-size: 14px;
            color: #757575;
        }

        .status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            margin-left: 8px;
        }

        .status.pass {
            background-color: #4CAF50;
            color: white;
        }

        .status.fail {
            background-color: #F44336;
            color: white;
        }

        .status.warning {
            background-color: #FF9800;
            color: white;
        }

        .summary {
            background-color: #2196F3;
            color: white;
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 32px;
        }

        .summary h2 {
            color: white;
            border-bottom: 2px solid white;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
            margin-top: 16px;
        }

        .stat {
            text-align: center;
        }

        .stat-number {
            font-size: 36px;
            font-weight: 700;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        button {
            background-color: #2196F3;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            margin: 8px 8px 8px 0;
        }

        button:hover {
            background-color: #1976D2;
        }

        #log {
            background-color: #212121;
            color: #4CAF50;
            padding: 16px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 16px;
        }

        .log-line {
            margin: 4px 0;
        }
    </style>

    <!-- Open Graph / OGP - Auto-generated by Bot -->
    <meta property="og:title" content="「ARアプリの開発」">
    <meta property="og:description" content="「ARアプリの開発」">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://vps.nekodigi.com/ccbot/projects/7fcc0eea">
    <meta property="og:image" content="https://vps.nekodigi.com/ccbot/projects/7fcc0eea/thumbnail.png">
    <meta property="og:image:width" content="1200">
    <meta property="og:image:height" content="630">

    <!-- Twitter Card - Auto-generated by Bot -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="「ARアプリの開発」">
    <meta name="twitter:description" content="「ARアプリの開発」">
    <meta name="twitter:image" content="https://vps.nekodigi.com/ccbot/projects/7fcc0eea/thumbnail.png">
  </head>
<body>
    <div class="container">
        <h1>AR体験アプリ - テストスイート</h1>

        <div class="summary">
            <h2>テスト結果サマリー</h2>
            <div class="summary-stats">
                <div class="stat">
                    <div class="stat-number" id="totalTests">0</div>
                    <div class="stat-label">総テスト数</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="passedTests">0</div>
                    <div class="stat-label">成功</div>
                </div>
                <div class="stat">
                    <div class="stat-number" id="failedTests">0</div>
                    <div class="stat-label">失敗</div>
                </div>
            </div>
        </div>

        <div>
            <button onclick="runAllTests()">すべてのテストを実行</button>
            <button onclick="clearLog()">ログをクリア</button>
        </div>

        <div id="testResults"></div>

        <h2>実行ログ</h2>
        <div id="log"></div>
    </div>

    <script>
        const tests = {
            fileStructure: [],
            pwa: [],
            ar: [],
            performance: []
        };

        let testResults = {
            total: 0,
            passed: 0,
            failed: 0,
            warnings: 0
        };

        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const line = document.createElement('div');
            line.className = 'log-line';
            const timestamp = new Date().toLocaleTimeString();
            line.textContent = `[${timestamp}] ${message}`;
            logDiv.appendChild(line);
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }

        async function checkFileExists(url) {
            try {
                const response = await fetch(url, { method: 'HEAD' });
                return response.ok;
            } catch (error) {
                return false;
            }
        }

        async function testFileStructure() {
            log('ファイル構造のテストを開始...');

            const files = [
                { path: './index.html', name: 'index.html' },
                { path: './style.css', name: 'style.css' },
                { path: './app.js', name: 'app.js' },
                { path: './manifest.json', name: 'manifest.json' },
                { path: './sw.js', name: 'Service Worker' },
                { path: './models/box.glb', name: 'Box Model' },
                { path: './models/sphere.glb', name: 'Sphere Model' },
                { path: './models/cylinder.glb', name: 'Cylinder Model' },
                { path: './icon-192.png', name: 'Icon 192x192' },
                { path: './icon-512.png', name: 'Icon 512x512' }
            ];

            for (const file of files) {
                const exists = await checkFileExists(file.path);
                tests.fileStructure.push({
                    name: file.name,
                    status: exists ? 'pass' : 'fail',
                    message: exists ? 'ファイルが存在します' : 'ファイルが見つかりません'
                });
                log(`${file.name}: ${exists ? '✓' : '✗'}`);
            }
        }

        async function testPWA() {
            log('PWA機能のテストを開始...');

            // Service Worker
            const swSupported = 'serviceWorker' in navigator;
            tests.pwa.push({
                name: 'Service Worker サポート',
                status: swSupported ? 'pass' : 'fail',
                message: swSupported ? 'Service Worker がサポートされています' : 'Service Worker がサポートされていません'
            });
            log(`Service Worker サポート: ${swSupported ? '✓' : '✗'}`);

            // Manifest
            try {
                const response = await fetch('./manifest.json');
                const manifest = await response.json();
                const hasRequiredFields = manifest.name && manifest.start_url && manifest.icons;
                tests.pwa.push({
                    name: 'Manifest 設定',
                    status: hasRequiredFields ? 'pass' : 'fail',
                    message: hasRequiredFields ? 'Manifest が正しく設定されています' : 'Manifest に不足があります'
                });
                log(`Manifest: ${hasRequiredFields ? '✓' : '✗'}`);
            } catch (error) {
                tests.pwa.push({
                    name: 'Manifest 設定',
                    status: 'fail',
                    message: 'Manifest の読み込みに失敗しました'
                });
                log('Manifest: ✗');
            }

            // HTTPS
            const isSecure = location.protocol === 'https:' || location.hostname === 'localhost';
            tests.pwa.push({
                name: 'セキュア接続',
                status: isSecure ? 'pass' : 'warning',
                message: isSecure ? 'HTTPS接続です' : 'HTTPS接続ではありません (本番環境で必要)'
            });
            log(`HTTPS: ${isSecure ? '✓' : '⚠'}`);
        }

        async function testAR() {
            log('AR機能のテストを開始...');

            // WebXR サポート
            const xrSupported = 'xr' in navigator;
            tests.ar.push({
                name: 'WebXR API サポート',
                status: xrSupported ? 'pass' : 'warning',
                message: xrSupported ? 'WebXR API がサポートされています' : 'WebXR API はサポートされていません (AR対応デバイスで必要)'
            });
            log(`WebXR API: ${xrSupported ? '✓' : '⚠'}`);

            if (xrSupported) {
                try {
                    const isARSupported = await navigator.xr.isSessionSupported('immersive-ar');
                    tests.ar.push({
                        name: 'AR セッション サポート',
                        status: isARSupported ? 'pass' : 'warning',
                        message: isARSupported ? 'ARセッションがサポートされています' : 'ARセッションはサポートされていません'
                    });
                    log(`AR Session: ${isARSupported ? '✓' : '⚠'}`);
                } catch (error) {
                    tests.ar.push({
                        name: 'AR セッション サポート',
                        status: 'warning',
                        message: 'ARセッションのチェックに失敗しました'
                    });
                    log('AR Session: ⚠');
                }
            }

            // Model Viewer
            const modelViewerLoaded = typeof customElements !== 'undefined' && customElements.get('model-viewer');
            tests.ar.push({
                name: 'Model Viewer ロード',
                status: modelViewerLoaded ? 'pass' : 'warning',
                message: modelViewerLoaded ? 'Model Viewer が読み込まれています' : 'Model Viewer の読み込みを確認できません'
            });
            log(`Model Viewer: ${modelViewerLoaded ? '✓' : '⚠'}`);
        }

        async function testPerformance() {
            log('パフォーマンステストを開始...');

            if ('performance' in window) {
                const perfData = performance.getEntriesByType('navigation')[0];
                if (perfData) {
                    const loadTime = perfData.loadEventEnd - perfData.fetchStart;
                    const isGoodPerformance = loadTime < 3000;

                    tests.performance.push({
                        name: 'ページ読み込み時間',
                        status: isGoodPerformance ? 'pass' : 'warning',
                        message: `${Math.round(loadTime)}ms ${isGoodPerformance ? '(良好)' : '(改善の余地あり)'}`
                    });
                    log(`Load Time: ${Math.round(loadTime)}ms ${isGoodPerformance ? '✓' : '⚠'}`);

                    const domContentLoaded = perfData.domContentLoadedEventEnd - perfData.fetchStart;
                    tests.performance.push({
                        name: 'DOM読み込み時間',
                        status: 'pass',
                        message: `${Math.round(domContentLoaded)}ms`
                    });
                    log(`DOM Load: ${Math.round(domContentLoaded)}ms ✓`);
                }
            }

            // メモリ使用量 (対応ブラウザのみ)
            if (performance.memory) {
                const memoryMB = (performance.memory.usedJSHeapSize / 1024 / 1024).toFixed(2);
                tests.performance.push({
                    name: 'メモリ使用量',
                    status: 'pass',
                    message: `${memoryMB} MB`
                });
                log(`Memory: ${memoryMB}MB ✓`);
            }
        }

        function displayResults() {
            const resultsDiv = document.getElementById('testResults');
            resultsDiv.innerHTML = '';

            testResults = { total: 0, passed: 0, failed: 0, warnings: 0 };

            const sections = [
                { title: 'ファイル構造', tests: tests.fileStructure },
                { title: 'PWA機能', tests: tests.pwa },
                { title: 'AR機能', tests: tests.ar },
                { title: 'パフォーマンス', tests: tests.performance }
            ];

            sections.forEach(section => {
                if (section.tests.length === 0) return;

                const sectionDiv = document.createElement('div');
                sectionDiv.className = 'test-section';

                const title = document.createElement('h2');
                title.textContent = section.title;
                sectionDiv.appendChild(title);

                section.tests.forEach(test => {
                    testResults.total++;
                    if (test.status === 'pass') testResults.passed++;
                    else if (test.status === 'fail') testResults.failed++;
                    else if (test.status === 'warning') testResults.warnings++;

                    const testDiv = document.createElement('div');
                    testDiv.className = `test-item ${test.status}`;

                    const nameDiv = document.createElement('div');
                    nameDiv.className = 'test-name';
                    nameDiv.innerHTML = `${test.name} <span class="status ${test.status}">${
                        test.status === 'pass' ? '成功' : test.status === 'fail' ? '失敗' : '警告'
                    }</span>`;

                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'test-result';
                    resultDiv.textContent = test.message;

                    testDiv.appendChild(nameDiv);
                    testDiv.appendChild(resultDiv);
                    sectionDiv.appendChild(testDiv);
                });

                resultsDiv.appendChild(sectionDiv);
            });

            // サマリー更新
            document.getElementById('totalTests').textContent = testResults.total;
            document.getElementById('passedTests').textContent = testResults.passed;
            document.getElementById('failedTests').textContent = testResults.failed + testResults.warnings;

            log(`\nテスト完了: ${testResults.passed}/${testResults.total} 成功`);
        }

        async function runAllTests() {
            log('=== テスト実行開始 ===');

            // テスト結果をリセット
            tests.fileStructure = [];
            tests.pwa = [];
            tests.ar = [];
            tests.performance = [];

            await testFileStructure();
            await testPWA();
            await testAR();
            await testPerformance();

            displayResults();

            log('=== テスト実行完了 ===');
        }

        // ページ読み込み時に自動実行
        window.addEventListener('load', () => {
            setTimeout(runAllTests, 500);
        });
    </script>
</body>
</html>
